<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 Panel (MQTT)</title>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--text:#eaf0ff;--muted:#a8b3d6;--accent:#4da3ff;--ok:#20c997;--bad:#ff5c7a;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:grid;place-items:center;padding:24px}
    .wrap{width:100%;max-width:920px}
    .card{background:#121a33;border:1px solid #22305a;border-radius:16px;padding:18px}
    .grid{display:grid;gap:12px}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr 1fr}}
    label{display:block;font-weight:700;margin:0 0 6px}
    input,textarea{width:100%;background:#0c1230;color:var(--text);border:1px solid #22305a;border-radius:12px;padding:12px;outline:none;font-size:15px}
    textarea{min-height:110px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;background:var(--accent);color:#051024;font-weight:900;padding:12px 16px;border-radius:12px;cursor:pointer}
    button.ghost{background:transparent;color:var(--text);border:1px solid #22305a}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{margin-top:14px;padding:12px;border-radius:12px;border:1px dashed #2b3a6a;color:var(--muted);white-space:pre-wrap}
    .ok{color:var(--ok);border-color:#20c99766}
    .bad{color:var(--bad);border-color:#ff5c7a66}
    .sensor{margin-top:14px;padding:14px;border-radius:14px;border:1px solid #22305a;background:#0c1230}
    .row{display:flex;justify-content:space-between;gap:10px}
    code{background:#0a1028;padding:2px 6px;border-radius:8px;border:1px solid #22305a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Panel Web ‚Üí ESP32 (MQTT)</h2>
      <div class="grid">
        <div>
          <label>Broker (WSS)</label>
          <input id="broker" value="wss://broker.emqx.io:8084/mqtt" />
        </div>
        <div>
          <label>Usuario (opcional)</label>
          <input id="user" />
        </div>
        <div>
          <label>Contrase√±a (opcional)</label>
          <input id="pass" type="password" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>Mensaje para el display</label>
        <textarea id="text" placeholder="Escrib√≠ el mensaje..."></textarea>
      </div>

      <div class="actions">
        <button id="connectBtn">Conectar</button>
        <button id="disconnectBtn" class="ghost" disabled>Desconectar</button>
        <button id="sendBtn" disabled>Enviar</button>
      </div>

      <div class="sensor">
        <div class="row"><span>Temperatura</span><b><span id="t">--.-</span> ¬∞C</b></div>
        <div class="row"><span>Humedad</span><b><span id="h">--</span> %</b></div>
        <div class="row"><span>Estado</span><b><span id="ok">---</span></b></div>
        <div class="row"><span>√öltima actualizaci√≥n</span><b><span id="ago">---</span></b></div>
      </div>

      <div id="status" class="status">Listo. Toc√° ‚ÄúConectar‚Äù.</div>

      <p style="color:var(--muted);font-size:13px;margin-top:10px;">
        Display: <code id="tdisp"></code><br>
        Sensor: <code id="tsens"></code>
      </p>
    </div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const TOPIC_DISPLAY = "esp32/roldansergio/display/75169856249c6";
    const TOPIC_SENSOR  = "esp32/roldansergio/sensor/75169856249c6";

    document.getElementById("tdisp").textContent = TOPIC_DISPLAY;
    document.getElementById("tsens").textContent = TOPIC_SENSOR;

    const $ = (id) => document.getElementById(id);

    const brokerEl = $("broker");
    const userEl   = $("user");
    const passEl   = $("pass");
    const textEl   = $("text");

    const connectBtn = $("connectBtn");
    const disconnectBtn = $("disconnectBtn");
    const sendBtn = $("sendBtn");

    const tEl = $("t");
    const hEl = $("h");
    const okEl = $("ok");
    const agoEl = $("ago");
    const statusBox = $("status");

    let client = null;
    let lastTs = 0;

    function setStatus(msg, type="info"){
      statusBox.classList.remove("ok","bad");
      if(type==="ok") statusBox.classList.add("ok");
      if(type==="bad") statusBox.classList.add("bad");
      statusBox.textContent = msg;
    }

    function setUi(connected){
      connectBtn.disabled = connected;
      disconnectBtn.disabled = !connected;
      sendBtn.disabled = !connected;
    }

    function connect(){
      const broker = brokerEl.value.trim();
      const user = userEl.value.trim();
      const pass = passEl.value;

      if(!broker){
        setStatus("‚ö†Ô∏è Pon√© un broker WSS.", "bad");
        return;
      }

      const clientId = "web_" + Math.random().toString(16).slice(2);
      setStatus("Conectando‚Ä¶");

      client = mqtt.connect(broker, {
        clientId,
        username: user || undefined,
        password: pass || undefined,
        clean: true,
        reconnectPeriod: 1500,
        connectTimeout: 8000,
      });

      client.on("connect", () => {
        setUi(true);
        setStatus("‚úÖ Conectado. Suscrito al sensor.", "ok");
        client.subscribe(TOPIC_SENSOR, { qos: 0 });
      });

      client.on("reconnect", () => setStatus("üîÑ Reintentando‚Ä¶"));
      client.on("close", () => { setUi(false); setStatus("Desconectado."); });
      client.on("error", (e) => { setUi(false); setStatus("‚ùå Error:\n"+e, "bad"); });

      client.on("message", (topic, payload) => {
        if(topic !== TOPIC_SENSOR) return;
        try{
          const j = JSON.parse(payload.toString());
          tEl.textContent = Number(j.temp).toFixed(1);
          hEl.textContent = Math.round(Number(j.hum));
          okEl.textContent = j.ok ? "OK" : "ERROR";
          lastTs = Number(j.ts) || Date.now();
        }catch(err){
          okEl.textContent = "JSON inv√°lido";
        }
      });
    }

    function disconnect(){
      if(client){
        client.end(true);
        client = null;
      }
      setUi(false);
      setStatus("Desconectado.");
    }

    function send(){
      const text = textEl.value.trim();
      if(!text){
        setStatus("‚ö†Ô∏è Escrib√≠ un mensaje.", "bad");
        return;
      }
      if(!client || !client.connected){
        setStatus("‚ö†Ô∏è Primero conectate.", "bad");
        return;
      }
      const payload = JSON.stringify({ text, ts: Date.now() });
      client.publish(TOPIC_DISPLAY, payload, { qos: 0, retain: true }, (err) => {
        if(err) setStatus("‚ùå No se pudo enviar: "+err, "bad");
        else setStatus("‚úÖ Enviado al display.", "ok");
      });
    }

    // ‚Äúhace cu√°nto‚Äù (en base a ts del ESP32)
    setInterval(() => {
      if(!lastTs){ agoEl.textContent = "---"; return; }
      const s = Math.max(0, Math.round((Date.now() - lastTs)/1000));
      agoEl.textContent = s + "s";
    }, 1000);

    connectBtn.addEventListener("click", connect);
    disconnectBtn.addEventListener("click", disconnect);
    sendBtn.addEventListener("click", send);

    setUi(false);
  </script>
</body>
</html>
